# CLAUDE.md

このファイルは Claude Code (claude.ai/code) がこのリポジトリのコードを操作する際のガイダンスを提供します。

## プロジェクトの背景と目標

**Sid Note** はベースフレットボード可視化Webアプリケーションです。名前は「Sid Vicious」「Death Note」「音符」を組み合わせています。

### 課題設定
- ベースコード表には独特な指使いのポジション（オクターブ/弦のバリエーション）が表示されない
- TAB記譜は指使いを示すが、ミュート技法（右手、左手、指、パーム）を表現できない
- 既存のフレットボード図は静的画像（Photoshop作成）で、修正が困難

### ソリューション
- フィンガリングとミュート提案を理由とともに表示するCanvas生成フレットボード図
- 現在は個人使用（TSXに埋め込み）
- 将来：ブログ埋め込み用のCanvas画像を返すWeb API

### 現在の状況
- **sid-note_old**: 動作する参照実装（理想的な状態）
- **現在のバージョン**: AIリファクタリング後に劣化、復旧が必要

### リファクタリング目標
1. **機能復旧**: sid-note_oldから機能劣化なし
2. **スタイル復旧**: Tailwind CSSを削除し、インラインスタイルに戻す
3. **構造保持**: utils/ディレクトリ構成とcore/命名を維持
4. **テスト維持**: 貴重なテストケース（複雑な音楽コードを処理）を保持
5. **日本語記譜**: ♭（フラット）と＃（シャープ）文字をサポート

## 開発コマンド

```bash
# 開発サーバー
npm run dev

# プロダクションビルド
npm run build

# 型チェック
npm run type-check

# リンティング
npm run lint

# 全テスト実行
npm run test

# 特定のテストファイル実行
npm run test -- path/to/test.test.ts

# ウォッチモードでテスト実行
npm run test -- --watch
```

## プロジェクトアーキテクチャ

### コンポーネント構成

プロジェクトでは厳密なCSR/SSRコンポーネント分離を使用：

- `src/components/ssr/` - サーバーサイドレンダリングコンポーネント（静的コンテンツ）
- `src/components/csr/` - クライアントサイドレンダリングコンポーネント（インタラクティブ機能）

この分離は建築的なもので、SSRコンポーネントはデータ表示を扱い、CSRコンポーネントは音声再生や動的UIなどのユーザーインタラクションを扱います。

### 音楽理論ライブラリ

`src/utils/music/theory/`に配置されたこのライブラリは、「デフォルト + デルタ」設計パターンを使用した包括的な音楽理論実装です：

- **コアモジュール** (`core/`): 音符、インターバル、コード、スケール、ピッチ、周波数、記譜
- **ハーモニーモジュール** (`harmony/`): 機能和声分析とコード進行
- **オーディオモジュール** (`audio/`): 音生成と再生管理

コードシステムは「デフォルト + デルタ」パターンを実装し、コードはメジャートライアド（1, 3, 5）から開始し、修正を適用します（例：'m'は3を♭3に変更）。

### データ管理

- **YAML + Zod バリデーション**: トラックデータは`public/track/`にYAMLファイルとして保存
- **スキーマバリデーション**: `src/schemas/`には型安全なデータバリデーション用のZodスキーマ
- **ローダー**: `src/utils/loader/`がデータ読み込みとバリデーションを処理

### トラックデータ構造

各トラックには以下が含まれます：
- メタデータ（タイトル、アーティスト、キー、テンポ、拍子記号）
- セクション（イントロ、ヴァース、コーラスなど）
- フィンガリング指示付きの音符（指、弦、フレットポジション）
- 和声分析付きのコードセグメント

## 主要な技術パターン

### TypeScript設定

- 追加チェックを有効にした厳密モード（`noUnusedLocals`, `noImplicitReturns`）
- パスマッピング: `@/*` は `src/*` にマップ
- ESLintは明示的な関数戻り値型とno-anyポリシーを強制

### テスト戦略

- ts-jestプリセットのJest
- カバレッジ閾値は全メトリクスで80%に設定
- テストファイルは`*.test.ts`パターンに従う
- 音楽理論モジュールには包括的なユニットテスト

### ファイル命名規則

- Reactコンポーネント: PascalCase（例：`ChordSegment.tsx`）
- ユーティリティ: camelCase（例：`chordUtil.ts`）
- テストファイル: `*.test.ts`サフィックス
- スキーマファイル: `*Schema.ts`サフィックス

## 音楽理論ライブラリ仕様

### 設計哲学
- **カスタム実装**: 外部音楽理論ライブラリなし（日本語言語サポートのため）
- **ベース中心**: 4弦ベースが主、6弦ベースは将来サポート（ギターサポートは不要）
- **再利用可能**: 将来のNPMパッケージ候補

### 記譜標準
- **入力正規化**: b, #, ♯, ♭を受け入れ → 内部で♭, ＃に正規化
- **インターバル記譜**: ♭3, ＃5形式
- **ピッチ記譜**: C3, D♭4形式  
- **異名同音記譜**: C＃/D♭3形式（C＃3/D♭3ではない）
- **ローマ数字**: Ⅶ形式（VIIではない）
- **内部単位**: 計算にはフレット数（半音）を使用

### 必要な主要機能
- 正規化（♭, ＃）
- 音符/オクターブ解析（正規表現）
- インターバル/ピッチ/コード/キー/スケール/カデンツ変換
- 機能和声分析
- コードボイシング生成

### 参照実装
- **sid-note_old**: 正しい動作の参照
- **現在のテスト**: 保持すべき貴重なテストケース
- **テスト期待値**: 新しい内部単位に対して更新が必要な可能性

## 音楽理論実装ノート

音楽理論モジュールを扱う際は：

- コード解析は正規表現パターンを使用して音楽情報を抽出
- インターバル計算は半音ベース
- 音名はシャープ（#）とフラット（♭）両方の記譜をサポート
- 音声生成は正確な周波数制御にWeb Audio APIを使用

## 開発ワークフロー

1. コミット前に必ず型チェック実行: `npm run type-check`
2. コードリント: `npm run lint`
3. 音楽理論の正確性を確保するためテスト実行: `npm run test`
4. 新機能追加時は既存のコンポーネントパターンを使用
5. 新コンポーネントではCSR/SSR分離に従う

## リファクタリング原則

### 優先順序
1. **sid-note_oldが真実**: 不確実な場合、sid-note_oldの動作が正しい
2. **機能退行なし**: 全機能は以前と同様に動作する必要
3. **貴重なテスト保持**: テストケースは複雑な音楽シナリオを処理
4. **内部構造改善**: 外部変更なしでより良い組織化

### アプローチ
- Tailwind CSSを完全に削除し、インラインスタイルに戻す
- ディレクトリ構造を保持しながら壊れたutils/機能を修正
- 内部単位が変更された場合はテスト期待値を更新
- CSR/SSRコンポーネント分離を維持
- core/命名と組織化を維持

## 作業履歴

### 2025/6/10 - デバッグ実行修正
- Next.js 14.1.0 → 15.3.2 アップグレード
- React 18 → 19 アップグレード  
- paramsのPromise型互換性を修正
- 未使用変数とインポートエラーを削除
- ビルドと開発サーバーの機能を正常に復旧